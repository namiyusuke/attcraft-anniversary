---
interface Props {
  title: string;
  description?: string;
}

const { title, description = "Astro テンプレート" } = Astro.props;
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
  </head>
  <body>
    <main id="swup">
      <slot />
    </main>
    <!-- トランジション用SVG -->
    <svg class="transition-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
      <path class="transition-path1" d="M 0 0 V 0 Q 50 0 100 0 V 0 z"></path>
      <path class="transition-path2" d="M 0 0 V 0 Q 50 0 100 0 V 0 z"></path>
      <path class="transition-path3" d="M 0 0 V 0 Q 50 0 100 0 V 0 z"></path>
    </svg>
  </body>
</html>

<script>
  import Swup from "swup";
  import SwupJsPlugin from "@swup/js-plugin";
  import SwupHeadPlugin from "@swup/head-plugin";
  import gsap from "gsap";

  // SVGパス要素を取得
  const path1 = document.querySelector(".transition-path1") as SVGPathElement;
  const path2 = document.querySelector(".transition-path2") as SVGPathElement;
  const path3 = document.querySelector(".transition-path3") as SVGPathElement;

  // SVGパスの状態
  const F = "M 0 100 V 150 Q 50 50 100 150 V 100 z"; // 画面外下部（開始）
  const E = "M 0 100 V 0 Q 50 -1 100 0 V 100 z"; // 画面全体を覆う
  const G = "M 0 0 V 150 Q 50 50 100 150 V 0 z"; // 画面を覆った状態
  const H = "M 0 0 V 0 Q 50 0 100 0 V 0 z"; // 画面外上部（消えた状態）

  // 色の組み合わせセット
  const colorSets: [string, string, string][] = [
    ["#d71e7b", "#ff4d9d", "#ffb3d9"], // ピンク系
    ["#1e90ff", "#4da6ff", "#b3d9ff"], // 青系
    ["#2ecc71", "#58d68d", "#abebc6"], // 緑系
    ["#9b59b6", "#bb8fce", "#d7bde2"], // 紫系
    ["#f39c12", "#f7dc6f", "#fdebd0"], // オレンジ・黄色系
    ["#e74c3c", "#f1948a", "#fadbd8"], // 赤系
  ];

  // ランダムに色の組み合わせを取得
  function getRandomColors(): [string, string, string] {
    const index = Math.floor(Math.random() * colorSets.length);
    return colorSets[index];
  }

  // パスの色を更新する関数
  function updatePathColors(colors: [string, string, string]) {
    path1.setAttribute("fill", colors[0]);
    path2.setAttribute("fill", colors[1]);
    path3.setAttribute("fill", colors[2]);
  }

  // ページ番号を取得する関数
  function getPageNumber(url: string): number {
    const match = url.match(/\/detail\/page(\d+)/);
    return match ? parseInt(match[1], 10) : 0;
  }

  // 遷移方向を保持（1: 次へ進む, -1: 前に戻る）
  let transitionDirection = 1;

  const swup = new Swup({
    plugins: [
      new SwupHeadPlugin(),
      new SwupJsPlugin({
        animations: [
          // detail配下のページ遷移: スライド
          {
            from: "/detail/:path*",
            to: "/detail/:path*",
            out: async () => {
              updatePathColors(["#f39c12", "#e67e22", "#d35400"]);
              const tl = gsap.timeline();
              // 進む: 左へ退場(-100%), 戻る: 右へ退場(100%)
              const exitX = transitionDirection === 1 ? "-100%" : "100%";
              await tl.to(".js-detail-page", { duration: 0.6, transform: `translateX(${exitX})`, ease: "power3.in" });
            },
            in: async () => {
              const tl = gsap.timeline();
              // 進む: 右から入場(100%→0%), 戻る: 左から入場(-100%→0%)
              const enterX = transitionDirection === 1 ? "100%" : "-100%";
              await tl
                .set(".js-detail-page", { transform: `translateX(${enterX})` })
                .to(".js-detail-page", { duration: 1.2, transform: "translateX(0%)", ease: "power3.out" });
            },
          },

          // デフォルト（その他のページ遷移）
          {
            from: "(.*)",
            to: "(.*)",
            out: async () => {
              // ランダムな色を適用
              const colors = getRandomColors();
              updatePathColors(colors);

              // 離脱アニメーション：下から波が覆う
              const tl = gsap.timeline();
              await tl
                .set(path1, { attr: { d: F } })
                .set(path2, { attr: { d: F } })
                .set(path3, { attr: { d: F } })
                .to(path1, { duration: 0.6, attr: { d: E }, ease: "power3.inOut" })
                .to(path2, { duration: 0.6, attr: { d: E }, ease: "power3.inOut" }, "-=0.45")
                .to(path3, { duration: 0.6, attr: { d: E }, ease: "power3.inOut" }, "-=0.45");
            },
            in: async () => {
              // 入場アニメーション：上へ波が抜ける
              const tl = gsap.timeline();
              await tl
                .set(path1, { attr: { d: G } })
                .set(path2, { attr: { d: G } })
                .set(path3, { attr: { d: G } })
                .to(path1, { duration: 0.6, attr: { d: H }, ease: "power3.inOut" })
                .to(path2, { duration: 0.6, attr: { d: H }, ease: "power3.inOut" }, "-=0.45")
                .to(path3, { duration: 0.6, attr: { d: H }, ease: "power3.inOut" }, "-=0.45");
            },
          },
        ],
      }),
    ],
  });

  (window as any).swup = swup;
  swup.hooks.on("page:view", () => {
    window.dispatchEvent(new Event("swup:pageview"));
  });

  // 遷移開始時に方向を判定
  swup.hooks.on("visit:start", (visit) => {
    const fromPage = getPageNumber(visit.from.url);
    const toPage = getPageNumber(visit.to.url);
    // 進む(toPage > fromPage) = 1, 戻る(toPage < fromPage) = -1
    transitionDirection = toPage > fromPage ? 1 : -1;
  });

  // detail間遷移時、コンテンツがDOMに挿入された直後に位置を設定（ちらつき防止）
  swup.hooks.on("content:replace", (visit) => {
    const fromDetail = visit.from.url.startsWith("/detail/");
    const toDetail = visit.to.url.startsWith("/detail/");

    if (fromDetail && toDetail) {
      const newDetailPage = document.querySelector(".js-detail-page") as HTMLElement;
      if (newDetailPage) {
        // 進む: 右側(100%)に配置, 戻る: 左側(-100%)に配置
        const enterX = transitionDirection === 1 ? "100%" : "-100%";
        newDetailPage.style.transform = `translateX(${enterX})`;
      }
    }
  });

  import "../scripts/main.js";
  import observer from "../assets/js/libs/Observer.js";

  // observerを初期化する関数
  function initDetailObserver() {
    new observer(".js-detail", "detail-visible");
  }
  // 初回実行
  initDetailObserver();
  // swupページ遷移後に再実行
  window.addEventListener("swup:pageview", initDetailObserver);

  // スクロール遷移の設定
  const scrollNavigationMap: { [key: string]: string } = {
    "/detail/page1": "/detail/page2",
    "/detail/page2": "/detail/page3",
    "/detail/page3": "/detail/page4",
    // 必要に応じて追加
  };

  let currentScrollHandler: (() => void) | null = null;

  // function initScrollNavigation() {
  //   // 前のハンドラーを削除
  //   if (currentScrollHandler) {
  //     window.removeEventListener("scroll", currentScrollHandler);
  //     currentScrollHandler = null;
  //   }

  //   const currentPath = window.location.pathname;
  //   const nextPage = scrollNavigationMap[currentPath];
  //   const prePage = Object.keys(scrollNavigationMap).find((key) => scrollNavigationMap[key] === currentPath);

  //   // 遷移先も前ページもない場合は何もしない
  //   if (!nextPage && !prePage) return;

  //   let hasNavigated = false;
  //   let lastScrollTop = window.scrollY || 0;

  //   currentScrollHandler = () => {
  //     if (hasNavigated) return;

  //     const scrollTop = window.scrollY || document.documentElement.scrollTop;
  //     const scrollHeight = document.documentElement.scrollHeight;
  //     const clientHeight = document.documentElement.clientHeight;
  //     const scrollingUp = scrollTop < lastScrollTop;

  //     // 最下部から100px以内に到達したら次のページへ
  //     if (nextPage && scrollTop + clientHeight >= scrollHeight - 100) {
  //       hasNavigated = true;
  //       if ((window as any).swup) {
  //         (window as any).swup.navigate(nextPage);
  //       } else {
  //         window.location.href = nextPage;
  //       }
  //     }
  //     // 上にスクロールして最上部に到達したら前のページへ
  //     else if (prePage && scrollTop <= 0 && scrollingUp) {
  //       hasNavigated = true;
  //       if ((window as any).swup) {
  //         (window as any).swup.navigate(prePage);
  //       } else {
  //         window.location.href = prePage;
  //       }
  //     }

  //     lastScrollTop = scrollTop;
  //   };
  //   window.addEventListener("scroll", currentScrollHandler);
  // }

  // // 初回実行
  // initScrollNavigation();
  // // Swupページ遷移後に再実行
  // window.addEventListener("swup:pageview", initScrollNavigation);
</script>
<style>
  .transition-overlay {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
</style>
