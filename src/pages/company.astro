---
import { SITE } from "../config";
import Layout from "@layouts/Layout.astro";
import menu from "@assets/img/menu-title.svg";
import light_parts2 from "@assets/img/light_parts2.png";
import light_parts3 from "@assets/img/light_parts3.png";
import chockArt from "@assets/img/chock-art.png";
import company_people from "@assets/img/company_people.png";
import categoryPeople1 from "@assets/img/category_people1.png";
import categoryPeople2 from "@assets/img/category_people2.png";
import bar_10 from "@assets/img/bar_10.png";
import categoryTable1 from "@assets/img/category_table1.png";
import category_people4 from "@assets/img/category_people4.png";
import category_people5 from "@assets/img/category_people5.png";
import category_people6 from "@assets/img/category_people6.png";
import category_bottom_table from "@assets/img/category_bottom_table.png";
import category_bottom_people1 from "@assets/img/category_bottom_people1.png";
import category_bottom_people2 from "@assets/img/category_bottom_people2.png";
import category_bottom_people3 from "@assets/img/category_bottom_people3.png";
import category_bottom_people4 from "@assets/img/category_bottom_people4.png";
import category_bottom_people5 from "@assets/img/category_bottom_people5.png";
import category_bottom_people6 from "@assets/img/category_bottom_people6.png";
import twitter from "@assets/img/logo-x.png";
import facebook from "@assets/img/logo-facebook.png";
import instagram from "@assets/img/logo-Instagram.png";
import table_beer01 from "@assets/img/table_beer01.png";
import { Image } from "astro:assets";
---

<Layout
  title={`制作会社 | ${SITE.name}`}
  description="制作会社にまつわるエピソードを集めました。サロンメンバーの実体験に基づく会話を、ぜひ盗みぎきしてみてください。"
>
  <main class="hunting category">
    <div class="heading-wrapper">
      <div class="heading__border">
        <h1 class="-border heading">
          <span class="heading-inline">
            <span class="-lg -sp">制作会社の話</span>
            <span class="-line">
              <span class="-sm">を</span>
              <span class="-lg -inline">盗</span>
              <span class="decorate-ear -sm -title">みぎき</span>
            </span>
          </span>
        </h1>
      </div>
      <Image class="category-light-parts1" src={light_parts3} alt="ライト" />
      <Image class="category-light-parts2" src={light_parts2} alt="ライト" />
      <!-- <figure class="heading__light1">
        <Image src={light01} alt="ライト" />
      </figure> -->
      <div class="category-top">
        <div class="hunting-image--center">
          <figure class="category-top--people company-image--move">
            <Image src={company_people} alt="制作会社の人々" />
          </figure>
        </div>
        <div class="category-top--text _01">
          <p class="js-text-target">
            熱意をラブレターで<br />伝える就活って<br />めちゃめちゃ素敵！！
          </p>
        </div>
        <div class="category-top--text _02">
          <p class="js-text-target">身を置く環境で<br />成長するスピードは<br />変わる！</p>
        </div>
        <div class="category-top--text _03">
          <p class="js-text-target">同じ方向性で<br />技術の話が<br />できるメンバー！</p>
        </div>
      </div>
      <figure class="hunting-art">
        <Image src={chockArt} alt="" />
      </figure>
      <figure class="category-hunting-people-02">
        <Image src={bar_10} alt="就活中の人々" />
      </figure>
    </div>
  </main>
  <section class="menu-section">
    <div class="category-people1__wrap">
      <figure class="decorate-ear category-people1 -reverse">
        <Image src={categoryPeople1} alt="就活中の人々" />
      </figure>
    </div>
    <figure class="category-people2">
      <Image src={categoryPeople2} alt="就活中の人々" />
    </figure>
    <figure class="category-table1">
      <Image src={categoryTable1} alt="就活中の人々" />
    </figure>

    <h2 class="menu-title">
      <span class="menu-title--inner">
        <span class="-ja">盗みぎき</span>
        <span class="-en"><Image src={menu} alt="menu" /></span>
      </span>
    </h2>
    <div class="menu-article--wrap -category">
      <div class="menu-article--list" id="summary-display">
        <!-- ここに動的にRSSデータが表示されます -->
      </div>
      <figure class="table_beer1">
        <Image src={table_beer01} alt="就活中の人々" />
      </figure>
    </div>
  </section>
  <div class="category-footer-wrap">
    <div class="category-footer">
      <figure class="decorate-ear category-people4 -reverse">
        <Image src={category_people4} alt="就活中の人々" />
      </figure>

      <figure class="decorate-ear category-people6">
        <Image src={category_people6} alt="就活中の人々" />
      </figure>
      <p class="footer-copy">
        <small>©2024 ︎Shibajuku.</small>
      </p>
    </div>
    <div class="">
      <figure class="category-bottom--table">
        <Image src={category_bottom_table} alt="就活中の人々" />
      </figure>
      <figure class="category-bottom--people1">
        <Image src={category_bottom_people1} alt="就活中の人々" />
      </figure>
      <figure class="category-bottom--people2">
        <Image src={category_bottom_people2} alt="就活中の人々" />
      </figure>
      <figure class="category-bottom--people3">
        <Image src={category_bottom_people3} alt="就活中の人々" />
      </figure>
      <figure class="category-bottom--people4">
        <Image src={category_bottom_people4} alt="就活中の人々" />
      </figure>
      <figure class="category-bottom--people5">
        <Image src={category_bottom_people5} alt="就活中の人々" />
      </figure>
      <figure class="category-people5">
        <Image src={category_people5} alt="就活中の人々" />
      </figure>
      <div class="js-observer category-bottom-share">
        <div class="is-observer-comment">
          <div class="category-bottom-share--text">
            <p><span class="-sm">盗みぎき<br />をシェアしてみませんか？</span></p>
            <ul class="category-bottom-share--list">
              <li class="category-bottom-share--twitter">
                <a
                  href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.origin)}&text=${encodeURIComponent("盗みぎきをシェア")}`}
                  target="_blank"
                  rel="noopener noreferrer"><img src={twitter.src} alt="twitter" /></a
                >
              </li>
              <li class="category-bottom-share--facebook">
                <a
                  href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.origin)}`}
                  target="_blank"
                  rel="noopener noreferrer"><img src={facebook.src} alt="facebook" /></a
                >
              </li>
            </ul>
          </div>
        </div>
        <figure class="decorate-ear category-bottom-share--people -reverse">
          <Image src={category_bottom_people6} alt="就活中の人々" />
        </figure>
      </div>
    </div>
  </div>
</Layout>
<script client:load>
  const xmlUrl = "https://anchor.fm/s/132fb79c/podcast/rss";
  const INITIAL_DISPLAY_COUNT = 6;
  let allEpisodes = []; // 全エピソードを保持する配列

  async function fetchEpisodes(limit = null) {
    try {
      // まだ全エピソードを取得していない場合のみfetchする
      if (allEpisodes.length === 0) {
        const response = await fetch(xmlUrl);
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const items = xmlDoc.getElementsByTagName("item");

        // 全エピソードのデータを整形して保存
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const episode = formatEpisodeData(item, items.length - i);
          if (episode.isRelevant) {
            allEpisodes.push(episode);
          }
        }
      }

      // 表示件数を制限するか全件返すか
      return limit ? allEpisodes.slice(0, limit) : allEpisodes;
    } catch (error) {
      console.error("Error fetching episodes:", error);
      return [];
    }
  }

  // エピソードデータの整形
  function formatEpisodeData(item, index) {
    const maxTitleLength = 46;
    const titleElement = item.getElementsByTagName("title")[0];
    const durationElement = item.getElementsByTagNameNS("*", "duration")[0];
    const summaryElements = item.getElementsByTagNameNS("*", "summary");

    let title = titleElement ? titleElement.textContent : "No title";
    let summary = summaryElements.length > 0 ? summaryElements[0].textContent : "No summary";
    let duration = durationElement ? durationElement.textContent : "Unknown duration";

    // タイトルの長さ制限
    if (title.length > maxTitleLength) {
      title = title.slice(0, maxTitleLength) + "...";
    }

    // durationのフォーマット
    if (duration.startsWith("00:")) {
      duration = duration.slice(3);
    }

    return {
      title,
      duration,
      url: `/episode-${index}`,
      isRelevant: title.includes("会社") || summary.includes("会社"),
    };
  }

  // エピソードのHTML生成
  function generateEpisodeHTML(episode, isHidden = false) {
    return `
      <article class="menu-article">
        <a href=${episode.url} class="menu-article--item ${isHidden ? "is-more-button--hidden" : ""}">
          <span  class="menu-article--body">
          <span>
              <h3 class="menu-article--number">${episode.title}</h3>
              <p class="menu-article--time">${episode.duration}</p>
          </span>
         </span>
        </a>
    </article>
    `;
  }

  // 初期表示ともっと見るボタンの設定
  async function initializeEpisodeDisplay() {
    const summaryDisplay = document.getElementById("summary-display");

    // 最初の6件を取得して表示
    const initialEpisodes = await fetchEpisodes(INITIAL_DISPLAY_COUNT);

    if (initialEpisodes.length === 0) {
      summaryDisplay.textContent = "該当するエピソードはありません。";
      return;
    }

    // 初期エピソードの表示
    summaryDisplay.innerHTML = initialEpisodes.map((episode) => generateEpisodeHTML(episode)).join("");

    // 全件数を確認して必要な場合はもっと見るボタンを表示
    const totalEpisodes = allEpisodes.length;

    if (totalEpisodes > INITIAL_DISPLAY_COUNT) {
      const moreButtonHTML = `
        <div class="more-button-wrapper category-bottom">
          <button type="button" class="more-button js-more-button ">
            エピソードをもっと見る
          </button>
        </div>
      `;
      summaryDisplay.insertAdjacentHTML("afterend", moreButtonHTML);
      function hiddenButton() {
        const hiddenButtonHTML = `
        <div class="more-button-wrapper category-bottom">
          <button type="button" class="more-button js-more-button -hidden">
            隠す
          </button>
        </div>
      `;
      }

      // もっと見るボタンのクリックイベント
      document.querySelector(".js-more-button").addEventListener("click", async function () {
        const buttonWrapper = this.closest(".more-button-wrapper .more-button");

        // 残りのエピソードを取得
        const remainingEpisodes = allEpisodes.slice(INITIAL_DISPLAY_COUNT);

        // 残りのエピソードを順番に表示
        remainingEpisodes.forEach((episode, index) => {
          setTimeout(() => {
            const episodeHTML = generateEpisodeHTML(episode, true);
            summaryDisplay.insertAdjacentHTML("beforeend", episodeHTML);

            // 少し遅延させて表示アニメーション
            setTimeout(() => {
              summaryDisplay.lastElementChild.classList.remove("is-more-button--hidden");
            }, 50);
          }, index * 10);
        });

        // ボタンを非表示にして削除
        // buttonWrapper.classList.add("is-hiding");
        setTimeout(() => buttonWrapper.remove(), 400);
        hiddenButton();
      });
    }
  }

  // 初期化実行
  initializeEpisodeDisplay();
</script>

<script>
  import spanWrap from "@assets/js/utils/spanWrap";
  const counter = { value: 0 };
  document.querySelectorAll(".js-text-target").forEach((el) => spanWrap(el, counter));
</script>

<script>
  // document.addEventListener("DOMContentLoaded", () => {
  //   const bgm = document.querySelector(".js-bgm");
  //   const bgmControl = document.querySelector(".js-bgm-control");

  //   if (bgm) {
  //     bgm.volume = 0.2;

  //     // 初期状態はミュート
  //     bgm.muted = true;

  //     // ユーザーインタラクションで再生を試みる
  //     const playBGM = async () => {
  //       try {
  //         bgm.muted = false;
  //         await bgm.play();

  //         // 再生成功時の処理（必要に応じて）
  //         bgmControl?.classList.add("is-playing");
  //       } catch (error) {
  //         console.warn("BGM autoplay failed:", error);
  //         // 再生失敗時の処理（必要に応じて）
  //         bgm.muted = true;
  //       }
  //     };

  //     // クリックなどのユーザーインタラクションで再生
  //     document.addEventListener("click", playBGM, { once: true });
  //     document.addEventListener("touchstart", playBGM, { once: true });
  //     document.addEventListener("keydown", playBGM, { once: true });

  //     // BGMコントロールボタンの処理
  //     bgmControl?.addEventListener("click", () => {
  //       if (bgm.muted) {
  //         bgm.muted = false;
  //         bgmControl.classList.add("is-playing");
  //       } else {
  //         bgm.muted = true;
  //         bgmControl.classList.remove("is-playing");
  //       }
  //     });
  //   }
  // });
</script>
