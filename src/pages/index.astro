---
import { SITE } from "../config";
import { Image } from "astro:assets";
import Layout from "@layouts/Layout.astro";
import LoadingPage from "@components/parts/Loading.astro";
import wine_tool from "@assets/img/wine_tool.png";
import wine_table from "@assets/img/wine_table.png";
import photo from "@assets/img/photo.png";
import drinkMenu from "@assets/img/drink-menu.png";
import direction_people from "@assets/img/direction_people.png";
import direction_menu from "@assets/img/direction_menu.png";
import coding_people from "@assets/img/coding_people.png";
import coding_menu from "@assets/img/coding_menu.png";
import design_people from "@assets/img/design_people.png";
import design_menu from "@assets/img/design_menu.png";
import bar from "@assets/img/bar.png";
import jobHunting_people from "@assets/img/jobHunting_people.png";
import jobHunting_menu from "@assets/img/jobHunting_menu.png";
import company_people from "@assets/img/company_people.png";
import company_menu from "@assets/img/company_menu.png";
import freeLance_people from "@assets/img/freeLance_people.png";
import freeLance_menu from "@assets/img/freeLance_menu.png";
import work_people from "@assets/img/work_people.png";
import work_menu from "@assets/img/work_menu.png";
import web_people from "@assets/img/web_people.png";
import jobHunting_people_sub from "@assets/img/jobHunting_people_sub.png";
// import web_people from "@assets/img/web.gif";
import web_menu from "@assets/img/web_menu.png";
import study_people from "@assets/img/study_people.png";
import study_menu from "@assets/img/study_menu.png";
import portfolio_people from "@assets/img/portfolio_people.png";
import portfolio_menu from "@assets/img/portfolio_menu.png";
import chockArt from "@assets/img/chock-art.png";
import mvBg from "@assets/img/bg_mv.png";
import kanpai from "@assets/img/kanpai.png";
import green_brunch from "@assets/img/green_brunch.svg";
import green_leaf01 from "@assets/img/green_leaf01.svg";
import green_leaf02 from "@assets/img/green_leaf02.svg";
import green_leaf03 from "@assets/img/green_leaf03.svg";
import green_leaf04 from "@assets/img/green_leaf04.svg";
import green_leaf05 from "@assets/img/green_leaf05.svg";
import green_leaf06 from "@assets/img/green_leaf06.svg";
import green_leaf07 from "@assets/img/green_leaf07.svg";
import bar_01 from "@assets/img/bar_01.png";
import bar_02 from "@assets/img/bar_02.png";
import bar_03 from "@assets/img/bar_03.png";
import bar_04 from "@assets/img/bar_04.png";
import bar_05 from "@assets/img/bar_05.png";
import bar_06 from "@assets/img/bar_06.png";
import bar_07 from "@assets/img/bar_07.png";
import bar_08 from "@assets/img/bar_08.png";
import bar_09 from "@assets/img/bar_09.png";
import bar_10 from "@assets/img/bar_10.png";
import bar_11 from "@assets/img/bar_11.png";
import bar_13 from "@assets/img/bar_13.png";
import bar_14 from "@assets/img/bar_14.png";
import beer from "@assets/img/beer.png";
import bar_counter_people3 from "@assets/img/bar_counter_people3.png";
import bar_counter_people4 from "@assets/img/bar_counter_people4.png";
import bar_counter_people5 from "@assets/img/bar_counter_people5.png";
import bar_bottomTable from "@assets/img/bar_bottomTable.png";
import bar_bottomTable_stand from "@assets/img/bar_bottomTable_stand.png";
import bar_bottomTable_char1 from "@assets/img/bar_bottomTable_chra1.png";
import bar_bottomTable_char2 from "@assets/img/bar_bottomTable_chra2.png";
import bar_bottomTable_char3 from "@assets/img/bar_bottomTable_chra3.png";
import bar_bottomTable_char4 from "@assets/img/bar_bottomTable_chra4.png";
import bar_bottomTable_char5 from "@assets/img/bar_bottomTable_chra5.png";
import Loading from "@assets/js/libs/Loading";
import bar_table1 from "@assets/img/bar_table1.png";
import bar_table2 from "@assets/img/detail_beer.png";
import gesture_icon from "@assets/img/gesture_icon.svg";
import bgm from "@assets/audio/bgm.mp3";
import object_main_icon from "@assets/img/object_main_icon.png";
---

<Layout
  title={`${SITE.name} | `}
  description="Webクリエイター養成所Shibajukuのメンバーが集う、ポッドキャスト『シバジュク酒場』。Web制作にまつわるメンバー同士のリアルな会話をこっそり盗みぎきしながら、お楽しみください。"
  class="js-topPage"
>
  <LoadingPage />
  <main class="bg-bricks">
    <audio id="universalAudio" preload="none"></audio>
    <div class="maps-gesture">
      <div class="maps-gesture__bg"></div>
      <div class="maps-gesture__contents">
        <div class="maps-gesture__contents__icon">
          <Image src={gesture_icon} alt="ジェスチャー" />
        </div>
        <p class="c-crop c-ls maps-gesture__contents__txt">DRAG &amp; DROP<br />or<br /> SWIPE</p>
        <div class="maps-gesture__contents__character"></div>
      </div>
    </div>
    <div id="scroll-container">
      <div id="scroll-content">
        <div class="mv-kanpai">
          <Image src={kanpai} alt="乾杯" />
        </div>
        <div class="mv-bg">
          <Image src={mvBg} alt="メインビジュアル" />
        </div>
        <div class="bg_wine_table">
          <Image src={wine_table} alt="バーの下のテーブル" />
        </div>
        <div class="mv-title">
          <h2 class="mv-title--center">
            <span>
              <span class="mv-title--sm">ここは</span>
              <span class="mv-title--lg">シバジュク酒場</span>
              <span class="mv-title--white">隣の人の会話を盗みぎき</span>
            </span>
          </h2>
        </div>
        <div class="scroll-body">
          <div class="bg-wine">
            <Image src={wine_tool} alt="ワイン６本" />
          </div>
          <div class="bg-photo">
            <Image src={photo} alt="メニューの写真" />
          </div>
          <div class="bg-spotlight bg-drinkMenu">
            <Image src={drinkMenu} alt="メニューの写真" />
          </div>
          <div class="decorate-ear bg-bar13__wrap -reverse">
            <div class="bg-bar13">
              <Image src={bar_13} alt="カバンを持っている人" />
            </div>
          </div>
          <div class="decorate-ear bg-bar14__wrap -reverse">
            <div class="bg-bar14">
              <Image src={bar_14} alt="青い服を着た女性" />
            </div>
          </div>
          <div
            class="bg-direction js-spotlight"
            data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2020-11-6/135465423-44100-2-5968f0f452663.m4a"
          >
            <a href="/direction/">
              <span class="odject-direction--people">
                <span class="odject-direction--people__icon object_main_icon">
                  <Image src={object_main_icon} alt="" />
                </span>
                <Image src={direction_people} alt="ディレクション" />
              </span>
              <span class="odject-menu odject-direction--menu">
                <Image src={direction_menu} alt="ディレクションのメニュー" />
              </span>
            </a>
          </div>
          <div
            class="bg-coding js-spotlight"
            data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2023-4-21/330742665-44100-2-5edfae6160c83.m4a"
          >
            <a href="/coding/">
              <span class="odject-coding--people">
                <Image src={coding_people} alt="コーディング" />
                <span class="object_main_icon">
                  <Image src={object_main_icon} alt="" />
                </span>
              </span>
              <span class="odject-menu odject-coding--menu">
                <Image src={coding_menu} alt="コーディングのメニュー" />
              </span>
            </a>
          </div>
          <div
            class="bg-design js-spotlight"
            data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2022-1-17/248918979-44100-2-bb6ac1ff83d68.m4a"
          >
            <a href="/design/">
              <span class="odject-design--people">
                <Image src={design_people} alt="デザイン" />
                <span class="object_main_icon">
                  <Image src={object_main_icon} alt="" />
                </span>
              </span>
              <span class="odject-menu odject-design--menu">
                <Image src={design_menu} alt="デザインのメニュー" />
              </span>
            </a>
          </div>
          <div class="bg-bar">
            <Image src={bar} alt="バーカウンター" />
            <div class="bg-bar--beer1">
              <Image src={beer} alt="ビール" />
            </div>
            <div class="bg-bar--beer2">
              <Image src={beer} alt="ビール" />
            </div>
            <div class="bg-bar--beer3">
              <Image src={beer} alt="ビール" />
            </div>
          </div>
          <div class="bg-">
            <div class="bar-counter-people3">
              <Image src={bar_counter_people3} alt="バーのカウンター" />
            </div>
          </div>
          <div class="bg-">
            <div class="bar-counter-people4">
              <Image src={bar_counter_people4} alt="バーのカウンター" />
            </div>
          </div>
          <div class="bg-bar1">
            <Image src={bar_01} alt="バーカウンター" />
          </div>
          <div class="bg-bar2">
            <Image src={bar_02} alt="バーカウンター" />
          </div>
          <div class="bg-bar3">
            <Image src={bar_03} alt="バーカウンター" />
          </div>
          <div class="bg-bar4">
            <Image src={bar_04} alt="バーカウンター" />
          </div>
          <div class="bg-bar5">
            <Image src={bar_05} alt="バーカウンター" />
          </div>
          <div class="bg-bar6">
            <Image src={bar_06} alt="バーカウンター" />
          </div>
          <div class="bg-bar7">
            <Image src={bar_07} alt="バーカウンター" />
          </div>
          <div class="bg-bar8">
            <Image src={bar_08} alt="バーカウンター" />
          </div>
          <div class="bg-bar9__wrap">
            <div class="bg-bar9 decorate-ear">
              <Image src={bar_09} alt="バーカウンター" />
            </div>
          </div>
          <div class="bg-bar10">
            <Image src={bar_10} alt="バーカウンター" />
          </div>
          <div class="bg-bar11">
            <Image src={bar_11} alt="バーカウンター" />
          </div>
          <div class="bg-bottomTable">
            <Image src={bar_bottomTable} alt="バーの下のテーブル" />
          </div>
          <div class="bg-bottomTableStand__wrap">
            <div class="bg-bottomTableStand decorate-ear">
              <Image src={bar_bottomTable_stand} alt="バーの下のテーブル" />
            </div>
          </div>
          <div class="bg-">
            <div class="bar-counter-people5">
              <Image src={bar_counter_people5} alt="バーのカウンター" />
            </div>
          </div>
          <div class="decorate-ear bg-bottomTable-char1__wrap -reverse">
            <div class="bg-bottomTable-char1">
              <Image src={bar_bottomTable_char1} alt="バーの下のテーブル" />
            </div>
          </div>
          <div class="bg_bottomTable_chra2">
            <Image src={bar_bottomTable_char2} alt="バーの下のテーブル" />
          </div>
          <div class="bg_bottomTable_chra3">
            <Image src={bar_bottomTable_char3} alt="バーの下のテーブル" />
          </div>
          <div class="decorate-ear bg_bottomTable_chra4__wrap">
            <div class="bg_bottomTable_chra4">
              <Image src={bar_bottomTable_char4} alt="バーの下のテーブル" />
            </div>
          </div>
          <div class="bg_bottomTable_chra5">
            <Image src={bar_bottomTable_char5} alt="バーの下のテーブル" />
          </div>
        </div>
        <div
          class="bg-jobHunting js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2020-7-24/101029684-44100-2-144db6b663639.m4a"
        >
          <a href="/job-hunting/">
            <span class="odject-jobHunting--people">
              <Image src={jobHunting_people} alt="就活転職" />
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
            </span>
            <span class="odject-menu odject-jobHunting--menu">
              <Image src={jobHunting_menu} alt="就活転職のメニュー" />
            </span>
          </a>
        </div>
        <div class="decorate-ear bg-jobHuntingSub__wrap">
          <div class="bg-jobHuntingSub">
            <Image src={jobHunting_people_sub} alt="就活転職" />
          </div>
        </div>
        <div
          class="bg-company js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2023-11-14/5f367e6f-b788-50ab-56cc-5c4d7b1bd6f2.mp3"
        >
          <a href="/company/">
            <span class="odject-company--people">
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
              <Image src={company_people} alt="制作会社" />
            </span>
            <span class="odject-menu odject-company--menu">
              <Image src={company_menu} alt="制作会社のメニュー" />
            </span>
          </a>
        </div>
        <div
          class="bg-freeLance js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/production/2020-1-7/47126269-44100-2-d54667e7fd84f.mp3"
        >
          <a href="/free-lance/">
            <span class="odject-freeLance--people">
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
              <Image src={freeLance_people} alt="フリーランス" />
            </span>
            <span class="odject-menu odject-freeLance--menu">
              <Image src={freeLance_menu} alt="フリーランスのメニュー" />
            </span>
          </a>
        </div>
        <div
          class="bg-work js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2022-6-27/278253739-44100-2-52714b8b7c19d.m4a"
        >
          <a href="/work/">
            <span class="odject-company--people">
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
              <Image src={work_people} alt="仕事" />
            </span>
            <span class="odject-menu odject-company--menu">
              <Image src={work_menu} alt="仕事のメニュー" />
            </span>
          </a>
        </div>
        <div
          class="bg-web js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2020-10-9/126700875-44100-2-40e9aaeb6ca88.m4a"
        >
          <a href="/web/">
            <span class="odject-web--people">
              <Image src={web_people} alt="web" />
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
            </span>
            <span class="odject-menu odject-web--menu">
              <Image src={web_menu} alt="webのメニュー" />
            </span>
          </a>
        </div>
        <div class="bg-table1">
          <Image src={bar_table1} alt="バーのテーブル1" />
        </div>
        <div class="bg-table2">
          <Image src={bar_table2} alt="バーのテーブル2" />
        </div>
        <div
          class="bg-study js-spotlight"
          data-audio-url="https://d3ctxlq1ktw2nl.cloudfront.net/staging/2022-4-23/267341869-44100-2-d7c9330350787.m4a"
        >
          <a href="/study/">
            <span class="odject-study--people">
              <Image src={study_people} alt="勉強法" />
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
            </span>
            <span class="odject-menu odject-study--menu">
              <Image src={study_menu} alt="勉強法のメニュー" />
            </span>
          </a>
        </div>
        <div
          class="bg-portfolio js-spotlight"
          data-audio-url="https://anchor.fm/s/132fb79c/podcast/play/14878550/https%3A%2F%2Fd3ctxlq1ktw2nl.cloudfront.net%2Fproduction%2F2020-5-8%2F80381710-44100-2-08285c18a8227.mp3"
        >
          <a href="/portfolio/">
            <span class="odject-portfolio--people">
              <Image src={portfolio_people} alt="ポートフォリオ" />
              <span class="object_main_icon">
                <Image src={object_main_icon} alt="" />
              </span>
            </span>
            <span class="odject-menu odject-portfolio--menu">
              <Image src={portfolio_menu} alt="ポートフォリオのメニュー" />
            </span>
          </a>
        </div>
        <div class="bg-chockArt">
          <Image src={chockArt} alt="絵" />
        </div>
        <div class="bg-green">
          <div class="bg-green--brunch">
            <Image src={green_brunch} alt="草木" />
          </div>
          <div class="bg-green--leaf01">
            <Image src={green_leaf01} alt="草木" />
          </div>
          <div class="bg-green--leaf02">
            <Image src={green_leaf02} alt="草木" />
          </div>
          <div class="bg-green--leaf03">
            <Image src={green_leaf03} alt="草木" />
          </div>
          <div class="bg-green--leaf04">
            <Image src={green_leaf04} alt="草木" />
          </div>
          <div class="bg-green--leaf05">
            <Image src={green_leaf05} alt="草木" />
          </div>
          <div class="bg-green--leaf06">
            <Image src={green_leaf06} alt="草木" />
          </div>
          <div class="bg-green--leaf07">
            <Image src={green_leaf07} alt="草木" />
          </div>
        </div>
      </div>
    </div>
    <div class="light"></div>
  </main>
  <button class="js-control js-bgm-control">
    <span class="js-bgm-control--text">BGM</span>
    <span class="js-bgm-control--icon">
      <svg width="16" height="20" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M8.08133 0C7.00969 0 5.98194 0.425706 5.22418 1.18347C4.46642 1.94123 4.04072 2.96897 4.04072 4.04061V9.69747C4.04072 10.7691 4.46642 11.7968 5.22418 12.5546C5.98194 13.3124 7.00969 13.7381 8.08133 13.7381C9.15296 13.7381 10.1807 13.3124 10.9385 12.5546C11.6962 11.7968 12.1219 10.7691 12.1219 9.69747V4.04061C12.1219 2.96897 11.6962 1.94123 10.9385 1.18347C10.1807 0.425706 9.15296 0 8.08133 0ZM1.61635 8.88934C1.83068 8.88934 2.03623 8.97448 2.18778 9.12604C2.33933 9.27759 2.42447 9.48314 2.42447 9.69747C2.42447 11.1978 3.02046 12.6366 4.08133 13.6975C5.14219 14.7583 6.58103 15.3543 8.08133 15.3543C9.58162 15.3543 11.0205 14.7583 12.0813 13.6975C13.1422 12.6366 13.7382 11.1978 13.7382 9.69747C13.7382 9.48314 13.8233 9.27759 13.9749 9.12604C14.1264 8.97448 14.332 8.88934 14.5463 8.88934C14.7606 8.88934 14.9662 8.97448 15.1177 9.12604C15.2693 9.27759 15.3544 9.48314 15.3544 9.69747C15.3548 11.4867 14.6955 13.2133 13.5028 14.5471C12.3101 15.8808 10.6676 16.7281 8.88945 16.9269V18.5868C8.88945 18.8011 8.80431 19.0067 8.65275 19.1582C8.5012 19.3098 8.29565 19.3949 8.08133 19.3949C7.867 19.3949 7.66145 19.3098 7.5099 19.1582C7.35834 19.0067 7.2732 18.8011 7.2732 18.5868V16.9269C5.49502 16.7281 3.85252 15.8808 2.65981 14.5471C1.4671 13.2133 0.807884 11.4867 0.808228 9.69747C0.808228 9.48314 0.893369 9.27759 1.04492 9.12604C1.19647 8.97448 1.40202 8.88934 1.61635 8.88934Z"
          fill="black"></path>
      </svg>
    </span>
  </button>
  <audio class="js-bgm" src={bgm} loop></audio>
</Layout>

<script>
  /*******************************************************
   * 1) BGMの ON/OFF 状態を sessionStorage で保持
   *******************************************************/
  class AudioStateManager {
    static setIsPlaying(isPlaying) {
      sessionStorage.setItem("bgmPlaying", isPlaying.toString());
    }
    static getIsPlaying() {
      return sessionStorage.getItem("bgmPlaying") === "true";
    }
    static clear() {
      sessionStorage.removeItem("bgmPlaying");
    }
  }

  /*******************************************************
   * 2) モバイルデバイスかどうかを判定する関数
   *******************************************************/
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  document.addEventListener("DOMContentLoaded", () => {
    /*******************************************************
     * (A) ページに1つだけある<audio>要素
     *******************************************************/
    const universalAudio = document.getElementById("universalAudio");
    if (!universalAudio) {
      console.warn("universalAudio 要素が見つかりません。HTMLに <audio id='universalAudio'> を配置してください。");
      return;
    }

    // ★音量を初期化（例: 0.2 を最大値とする）
    let baseVolume = 0.2;
    universalAudio.volume = baseVolume;

    // 先読みを抑えて表示を軽く
    universalAudio.preload = "none";
    // 必要に応じてループする
    universalAudio.loop = false;

    /*******************************************************
     * (B) BGM ON/OFF 状態を sessionStorage で管理
     *******************************************************/
    let isBgmOn = AudioStateManager.getIsPlaying();
    let hasUserInteracted = false; // モバイルの自動再生制限対策
    let currentAudioUrl = null; // 今再生中の音源URL（切り替え時に活用）
    let mostVisibleElement = null; // いま最も可視のセクションを保持
    let pendingAudioPlay = false; // モバイルでの初回クリック待ち状態を表すフラグ

    /*******************************************************
     * (C) 初回だけモバイル再生許可を獲得する関数
     *******************************************************/
    async function initialPlayback() {
      try {
        // ミュート状態で再生→停止して「ユーザー操作で再生した」実績を得る
        universalAudio.muted = true;
        await universalAudio.play();
        universalAudio.pause();
        universalAudio.muted = false;

        hasUserInteracted = true;
        console.log("初回再生許可を獲得しました。");
        return true;
      } catch (err) {
        console.warn("初回再生許可獲得に失敗:", err);
        return false;
      }
    }

    /*******************************************************
     * (D) BGM ON / OFF ボタン処理
     *******************************************************/
    const loadingOnButton = document.querySelector(".js-loading--on");
    const loadingOffButton = document.querySelector(".js-loading--off");
    const controlButton = document.querySelectorAll(".js-control");

    controlButton.forEach((btn) => {
      btn.addEventListener("click", async () => {
        isBgmOn = !isBgmOn;
        console.log("BGMの状態:", isBgmOn);

        if (isBgmOn) {
          AudioStateManager.setIsPlaying(true);

          if (isMobileDevice()) {
            if (!hasUserInteracted) {
              const success = await initialPlayback();
              if (success && mostVisibleElement) {
                const audioUrl = mostVisibleElement.dataset.audioUrl;
                if (audioUrl) {
                  switchAudio(audioUrl);
                }
              } else {
                pendingAudioPlay = true;
                console.log("モバイル: ユーザー操作待ちをセットしました");
              }
            } else if (mostVisibleElement) {
              const audioUrl = mostVisibleElement.dataset.audioUrl;
              if (audioUrl) {
                switchAudio(audioUrl);
              }
            }
          } else if (mostVisibleElement) {
            const audioUrl = mostVisibleElement.dataset.audioUrl;
            if (audioUrl) {
              switchAudio(audioUrl);
            }
          }
        } else {
          AudioStateManager.setIsPlaying(false);
          universalAudio.pause();
          pendingAudioPlay = false;
        }
      });
    });

    if (loadingOnButton) {
      loadingOnButton.addEventListener("click", async () => {
        isBgmOn = true;
        AudioStateManager.setIsPlaying(true);

        if (isMobileDevice() && !hasUserInteracted) {
          const success = await initialPlayback();
          if (!success) {
            pendingAudioPlay = true;
            console.log("モバイル: ユーザー操作待ちをセットしました");
          }
        }

        // 現在最も可視な要素があれば、その音声をロードするが再生は開始しない
        if (mostVisibleElement) {
          const audioUrl = mostVisibleElement.dataset.audioUrl;
          if (audioUrl) {
            universalAudio.src = audioUrl;
            universalAudio.currentTime = START_TIME;
            currentAudioUrl = audioUrl;

            // PCまたはユーザー操作済みなら再生開始
            if (!isMobileDevice() || hasUserInteracted) {
              switchAudio(audioUrl);
            }

            console.log("Loading ON: 音声ソースを設定しました", audioUrl);
          }
        }
      });
    }

    if (loadingOffButton) {
      loadingOffButton.addEventListener("click", () => {
        isBgmOn = false;
        AudioStateManager.setIsPlaying(false);
        pendingAudioPlay = false;

        // 今の音声を停止
        universalAudio.pause();
        currentAudioUrl = null;
        console.log("Loading OFF で音声停止");
      });
    }

    /*******************************************************
     * モバイルの初回クリック検出と再生実行
     *******************************************************/
    if (isMobileDevice()) {
      document.addEventListener("click", () => {
        if (!hasUserInteracted && isBgmOn) {
          hasUserInteracted = true;
          console.log("モバイル: ユーザークリックを検出しました");

          if (pendingAudioPlay && mostVisibleElement) {
            const audioUrl = mostVisibleElement.dataset.audioUrl;
            if (audioUrl) {
              console.log("モバイル: 保留中の音声を再生します", audioUrl);
              switchAudio(audioUrl);
              pendingAudioPlay = false;
            }
          }
        }
      });
    }

    /*******************************************************
     * (E) Intersection Observerでセクション監視
     *******************************************************/
    const spotlights = document.querySelectorAll(".js-spotlight");

    let visibleList = []; // { target: Element, ratio: number } の配列

    const observerOptions = {
      root: null,
      rootMargin: "-10% 0px", // より敏感に反応するように調整
      threshold: [0, 0.25, 0.5, 0.75, 1.0], // しきい値を簡略化して処理を軽く
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const existing = visibleList.find((v) => v.target === entry.target);
          if (existing) {
            existing.ratio = entry.intersectionRatio;
          } else {
            visibleList.push({ target: entry.target, ratio: entry.intersectionRatio });
          }
          console.log("可視要素:", entry.target.dataset.audioUrl, "表示率:", entry.intersectionRatio);
        } else {
          visibleList = visibleList.filter((v) => v.target !== entry.target);
        }
      });

      // 可視要素リストの状態をログ
      console.log(
        "現在の可視要素リスト:",
        visibleList.map((v) => ({
          url: v.target.dataset.audioUrl,
          ratio: v.ratio,
        }))
      );

      // 何も見えていなければ停止
      if (visibleList.length === 0) {
        universalAudio.pause();
        currentAudioUrl = null;
        mostVisibleElement = null;
        return;
      }

      // intersectionRatio がもっとも大きい要素を探す
      let mostVisible = visibleList.reduce((prev, current) => (current.ratio > prev.ratio ? current : prev));

      const VISIBLE_THRESHOLD = 0.3; // しきい値を下げて反応を敏感に

      if (mostVisible.ratio < VISIBLE_THRESHOLD) {
        universalAudio.pause();
        currentAudioUrl = null;
        mostVisibleElement = null;
        return;
      }

      mostVisibleElement = mostVisible.target;
      const newUrl = mostVisibleElement.dataset.audioUrl;

      if (isBgmOn && newUrl !== currentAudioUrl) {
        console.log("音源切り替え:", {
          from: currentAudioUrl,
          to: newUrl,
          ratio: mostVisible.ratio,
        });

        // モバイルでユーザー操作がまだの場合は再生をペンディング
        if (isMobileDevice() && !hasUserInteracted) {
          pendingAudioPlay = true;
          console.log("モバイル: ユーザー操作待ちをセットしました");
          return;
        }

        // 初回のボタン押下直後は少し遅延させて再生開始
        if (!currentAudioUrl) {
          setTimeout(() => switchAudio(newUrl), 500);
        } else {
          switchAudio(newUrl);
        }
      }
    }, observerOptions);

    spotlights.forEach((elem) => observer.observe(elem));

    /*******************************************************
     * (F) 音源を切り替えて「途中(例:30秒)から再生」する関数
     *******************************************************/
    const START_TIME = 30; // 途中再生開始位置(秒) ここをお好みで調整

    async function switchAudio(audioUrl) {
      // 一旦停止
      universalAudio.pause();

      // 切り替え
      universalAudio.src = audioUrl;
      universalAudio.currentTime = START_TIME; // ★途中から再生
      currentAudioUrl = audioUrl;

      // PC or モバイルでユーザー操作済なら再生
      if (!isMobileDevice() || hasUserInteracted) {
        try {
          await universalAudio.play();
          console.log(`音源を「${audioUrl}」に切り替え、${START_TIME}秒目から再生開始`);
        } catch (err) {
          console.warn("再生に失敗:", err);

          // 失敗した場合、モバイルでのユーザー操作待ち
          // if (isMobileDevice()) {
          pendingAudioPlay = true;
          console.log("モバイル: 再生失敗のためユーザー操作待ちをセットしました");
          // }
        }
      } else {
        console.log("モバイル: ユーザー操作前のため再生ブロックされる可能性があります");
        pendingAudioPlay = true;
      }
    }

    /*******************************************************
     * (G) threshold を 0.0 ~ 1.0 まで 0.01 刻みで生成
     *******************************************************/
    function buildThresholdList() {
      const thresholds = [];
      for (let i = 0; i <= 1.0; i += 0.01) {
        thresholds.push(i);
      }
      return thresholds;
    }

    /*******************************************************
     * (H) ページ読込時、前回がONならONで開始
     *******************************************************/
    if (isBgmOn) {
      console.log("前回BGM ONのためON状態で開始");
      // PCなら自動再生されるブラウザが多い
      if (!isMobileDevice()) {
        hasUserInteracted = true;
      } else {
        // モバイルは初回クリック時の再生フラグを立てる
        pendingAudioPlay = true;
        console.log("モバイル: BGMはONですがユーザー操作待ちをセットしました");
      }
    } else {
      console.log("前回BGM OFFのためOFF状態で開始");
      universalAudio.pause();
      currentAudioUrl = null;
    }

    /*******************************************************
     * (I) マウスの位置に応じて音量を変化させる
     *******************************************************/
    // 例: 近いほどボリュームが大きく、遠いと小さくなる
    //     「距離 = 0」で volume = baseVolume（最大）、
    //     「距離 >= maxDistance」で volume = 0 とするイメージ

    let mouseX = 0;
    let mouseY = 0;

    // 適宜調整する
    const maxDistance = 300; // この距離以上は無音になるイメージ

    // mousemove イベントリスナー
    document.addEventListener("mousemove", (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;

      // いま最も可視な要素が存在し、かつBGMがONで再生中の場合のみ
      if (mostVisibleElement && isBgmOn && !universalAudio.paused) {
        updateVolumeByMouseDistance(mostVisibleElement);
      }
    });

    // 距離に応じて volume を更新する関数
    function updateVolumeByMouseDistance(targetElem) {
      // 要素の中心を求める
      const rect = targetElem.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      // マウスとの距離を計算 (2次元のユークリッド距離)
      const distance = Math.hypot(mouseX - centerX, mouseY - centerY);

      // 0～maxDistance の範囲を 1.0 ~ 0.0 に正規化
      // （distance=0 → volume=1, distance=maxDistance → volume=0）
      let vol = 1 - distance / maxDistance;
      // 0～1の範囲を超えないようにクランプ
      if (vol < 0) vol = 0;
      if (vol > 1) vol = 1;

      // 実際の音量には baseVolume を掛ける（例: baseVolume=0.2 を最大値とする）
      universalAudio.volume = vol * baseVolume;
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("scroll-container");
    // コンテナのサイズとスクロール量を取得
    const containerWidth = container.scrollWidth;
    const containerHeight = container.scrollHeight;
    const containerVisibleWidth = container.clientWidth;
    const containerVisibleHeight = container.clientHeight;

    // スクロール位置を中央に設定
    container.scrollLeft = (containerWidth - containerVisibleWidth) / 2;
    container.scrollTop = (containerHeight - containerVisibleHeight) / 2;

    class BGM {
      constructor() {
        this.audio = document.querySelector(".js-bgm");
        this.onButton = document.querySelector(".js-loading--on");
        this.offButton = document.querySelector(".js-loading--off");
        this.audioPlay = document.querySelector(".js-bgm-control");

        // モバイルデバイス検出
        this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // ユーザーインタラクションフラグ
        this.hasUserInteracted = false;

        // 初期状態を取得
        this.audioConditions = !AudioStateManager.getIsPlaying();

        if (this.audio) {
          this.audio.volume = 0.2;
          this.audio.preload = "auto"; // 確実に読み込む

          // クリックイベントを待ってから再生開始
          const startAudio = () => {
            this.tryPlayAudio();
            this.audioConditions = false;
            AudioStateManager.setIsPlaying(true);
            this.hasUserInteracted = true;

            // コントロールボタンの状態を更新
            const controlButtons = document.querySelectorAll(".js-control");
            controlButtons.forEach((btn) => btn.classList.add("is-active"));
          };

          const stopAudio = () => {
            this.audio.pause();
            this.audioConditions = true;
            AudioStateManager.setIsPlaying(false);

            // コントロールボタンの状態を更新
            const controlButtons = document.querySelectorAll(".js-control");
            controlButtons.forEach((btn) => btn.classList.remove("is-active"));
          };

          const toggleAudio = () => {
            if (this.audioConditions) {
              this.audioConditions = false;
              this.tryPlayAudio();
              AudioStateManager.setIsPlaying(true);
              this.hasUserInteracted = true;

              // コントロールボタンの状態を更新
              const controlButtons = document.querySelectorAll(".js-control");
              controlButtons.forEach((btn) => btn.classList.add("is-active"));
            } else {
              this.audioConditions = true;
              this.audio.pause();
              AudioStateManager.setIsPlaying(false);

              // コントロールボタンの状態を更新
              const controlButtons = document.querySelectorAll(".js-control");
              controlButtons.forEach((btn) => btn.classList.remove("is-active"));
            }
          };

          // 音声再生を試みるヘルパーメソッド（複数箇所で使用）
          this.tryPlayAudio = () => {
            const playPromise = this.audio.play();

            if (playPromise !== undefined) {
              playPromise.catch((error) => {
                console.log("再生エラー:", error);

                // モバイルデバイスでの自動再生制限対策
                if (error.name === "NotAllowedError") {
                  console.log("ユーザー操作が必要です - ミュートで再生を試みます");

                  // ミュートで再生を試みる（多くのブラウザではミュート状態なら自動再生可能）
                  this.audio.muted = true;
                  this.audio
                    .play()
                    .then(() => {
                      // 成功したら徐々にミュートを解除
                      setTimeout(() => {
                        this.audio.muted = false;
                      }, 1000);
                    })
                    .catch((e) => console.log("ミュート再生も失敗:", e));
                }
              });
            }
          };

          // ページ読み込み時の状態確認と再生
          const initializeAudio = () => {
            console.log("初期化中...");
            const isPlaying = AudioStateManager.getIsPlaying();
            console.log("ページ読み込み時の再生状態:", isPlaying);

            if (isPlaying) {
              this.audioConditions = false;

              // コントロールボタンの状態を更新
              const controlButtons = document.querySelectorAll(".js-control");
              controlButtons.forEach((btn) => btn.classList.add("is-active"));

              // モバイルではユーザーインタラクションを待つ
              if (!this.isMobile) {
                // PCの場合は通常通り再生を試みる
                if (this.audio.readyState >= 2) {
                  console.log("メタデータはすでに読み込まれています");
                  this.tryPlayAudio();
                } else {
                  console.log("メタデータの読み込みを待っています");
                  this.audio.addEventListener(
                    "loadedmetadata",
                    () => {
                      console.log("メタデータが読み込まれました");
                      this.tryPlayAudio();
                    },
                    { once: true }
                  );
                }
              } else {
                console.log("モバイルデバイス: ユーザーインタラクションを待ちます");
                // モバイルではロード時に再生せず、ユーザーインタラクションを待つ
                // この状態は後で使う
              }
            } else {
              this.audio.pause();
              this.audioConditions = true;
            }
          };

          // モバイルでの初回画面クリックイベント
          if (this.isMobile) {
            document.addEventListener(
              "click",
              () => {
                // まだインタラクションがなく、BGMがONに設定されている場合
                if (!this.hasUserInteracted && !this.audioConditions) {
                  console.log("モバイル: 初回クリックを検出、音声再生を試みます");
                  this.tryPlayAudio();
                  this.hasUserInteracted = true;
                }
              },
              { once: true }
            ); // 最初のクリックだけで十分
          }

          // onButton, offButton, audioPlayのイベントリスナー
          this.onButton.addEventListener("click", startAudio);
          this.offButton.addEventListener("click", stopAudio);
          this.audioPlay.addEventListener("click", toggleAudio);

          // window.onloadイベントで初期化（より確実）
          if (document.readyState === "complete") {
            console.log("ドキュメントはすでに完全に読み込まれています");
            initializeAudio();
          } else {
            console.log("window.onloadイベントを待機中");
            window.addEventListener("load", initializeAudio);
          }
        }
      }
    }

    new BGM();
    function hoverClass() {
      const hoverClass = document.querySelectorAll(".js-spotlight");
      hoverClass.forEach((element) => {
        element.addEventListener("mouseenter", () => {
          element.classList.add("is-hover");
        });
        element.addEventListener("mouseleave", () => {
          element.classList.remove("is-hover");
        });
      });
    }
    hoverClass();

    class MobileAudioController {
      constructor() {
        this.currentPlayingAudio = null;
        this.isInitialized = false;
      }

      async initialize() {
        if (this.isInitialized) return;

        // ユーザーインタラクション待機
        await new Promise((resolve) => {
          const initHandler = () => {
            document.removeEventListener("touchstart", initHandler);
            document.removeEventListener("click", initHandler);
            resolve();
          };
          // document.addEventListener("touchstart", initHandler);
          // document.addEventListener("click", initHandler);
        });

        this.isInitialized = true;
      }

      async playAudio(player) {
        // 現在再生中の音声があれば停止
        if (this.currentPlayingAudio && this.currentPlayingAudio !== player) {
          await this.currentPlayingAudio.stop();
        }

        try {
          await player.startPlaying();
          this.currentPlayingAudio = player;
        } catch (error) {
          console.error("Failed to play audio:", error);
        }
      }

      stopAllAudio() {
        if (this.currentPlayingAudio) {
          this.currentPlayingAudio.stop();
          this.currentPlayingAudio = null;
        }
      }
    }

    // グローバルなオーディオコントローラーのインスタンスを作成
    const mobileAudioController = new MobileAudioController();

    // スクロールイベントの処理を最適化
    if (isMobileDevice()) {
      let scrollEndTimeout;

      container.addEventListener(
        "scroll",
        () => {
          if (scrollEndTimeout) {
            clearTimeout(scrollEndTimeout);
          }

          // scrollEndTimeout = setTimeout(() => {
          //   handleAudioOnScrollComplete();
          // }, 100);
        },
        { passive: true }
      );

      // ページ離脱時に音声を停止
      window.addEventListener("beforeunload", () => {
        mobileAudioController.stopAllAudio();
      });

      // ページがバックグラウンドに移動した時に音声を停止
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          mobileAudioController.stopAllAudio();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const isFromInternalPage = document.referrer.includes(window.location.hostname);

      if (isFromInternalPage && isMobileDevice()) {
        // セッションストレージからBGMの状態を確認
        const shouldPlayBGM = AudioStateManager.getIsPlaying();

        if (shouldPlayBGM) {
          const visibleElement = Array.from(contentBlocks).find((element) => {
            const rect = element.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            return rect.top >= 0 && rect.top < viewportHeight;
          });

          if (visibleElement) {
            mobileInteractionManager.hasInteracted = true;
            setTimeout(() => {
              snapToCenter(visibleElement);
            }, 1000);
          }
        }
      }
    });
  });
</script>
